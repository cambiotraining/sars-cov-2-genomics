<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>SARS Genomic Surveillance</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../materials/04-wastewater/03-ww_visualisation.html" rel="next">
<link href="../../materials/04-wastewater/01-ww_surveillance.html" rel="prev">
<link href="../../site_libs/quarto-contrib/quarto-project/cambiotraining/courseformat/img/university-of-cambridge-favicon.ico" rel="icon">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../site_libs/quarto-contrib/quarto-project/cambiotraining/courseformat/img/university_crest_reversed.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Bioinformatics for SARS Genomic Surveillance</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/cambiotraining/sars-cov-2-genomics" rel="" target=""><i class="bi bi-github" role="img" aria-label="Bioinformatics Training Facility GitHub">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/bioinfocambs" rel="" target=""><i class="bi bi-twitter" role="img" aria-label="Bioinformatics Training Facility Twitter">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://genomic.social/@BioInfoCambs" rel="" target=""><i class="bi bi-mastodon" role="img" aria-label="Bioinformatics Training Facility Mastodon">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../materials/04-wastewater/01-ww_surveillance.html">Wastewater Samples</a></li><li class="breadcrumb-item"><a href="../../materials/04-wastewater/02-ww_abundance.html"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Lineage Abundance</span></a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Welcome</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Overview</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../setup.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Data &amp; Software</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">Introduction</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../materials/01-intro/01-surveillance.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">SARS-CoV-2 genomic surveillance</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../materials/01-intro/02-ngs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Introduction to NGS</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../materials/01-intro/03-workflows.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Bioinformatic workflows</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
 <span class="menu-text">Clinical Isolates</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../materials/02-isolates/01-consensus.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Consensus assembly</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../materials/02-isolates/02-qc.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Quality Control</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../materials/02-isolates/03-lineages.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Lineages and variants</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../materials/02-isolates/04-phylogeny.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Building phylogenetic trees</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
 <span class="menu-text">Case Studies</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../materials/03-case_studies/01-switzerland.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Switzerland (Nanopore)</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../materials/03-case_studies/02-southafrica.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">South Africa (Illumina)</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../materials/03-case_studies/03-eqa.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">EQA (Exercise)</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">
 <span class="menu-text">Wastewater Samples</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../materials/04-wastewater/01-ww_surveillance.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Wastewater Surveillance</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../materials/04-wastewater/02-ww_abundance.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Lineage Abundance</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../materials/04-wastewater/03-ww_visualisation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Abundance Visualisation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../materials/04-wastewater/04-ww_mutations.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Mutation Analysis</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true">
 <span class="menu-text">Software</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../materials/05-software/01-managing_software.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Managing Bioinformatics Software</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../materials/05-software/03-software_setup.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Software setup</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../materials/appendices/file_formats.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Common file formats</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../materials/appendices/unix_cheatsheet.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Unix cheat sheet</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../materials/appendices/quick_r.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">R fundamentals</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../materials/appendices/tools_and_resources.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Tools and Resources</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#bioinformatic-analysis" id="toc-bioinformatic-analysis" class="nav-link active" data-scroll-target="#bioinformatic-analysis"><span class="header-section-number">12.1</span> Bioinformatic analysis</a></li>
  <li><a href="#sec-ww-viralrecon" id="toc-sec-ww-viralrecon" class="nav-link" data-scroll-target="#sec-ww-viralrecon"><span class="header-section-number">12.2</span> Wastewater pipeline</a>
  <ul class="collapse">
  <li><a href="#depth-threshold" id="toc-depth-threshold" class="nav-link" data-scroll-target="#depth-threshold"><span class="header-section-number">12.2.1</span> Depth threshold</a></li>
  <li><a href="#confidence-intervals" id="toc-confidence-intervals" class="nav-link" data-scroll-target="#confidence-intervals"><span class="header-section-number">12.2.2</span> Confidence intervals</a></li>
  </ul></li>
  <li><a href="#output-files" id="toc-output-files" class="nav-link" data-scroll-target="#output-files"><span class="header-section-number">12.3</span> Output Files</a></li>
  <li><a href="#sec-demix" id="toc-sec-demix" class="nav-link" data-scroll-target="#sec-demix"><span class="header-section-number">12.4</span> Freyja <code>demix</code> output</a></li>
  <li><a href="#quality-control" id="toc-quality-control" class="nav-link" data-scroll-target="#quality-control"><span class="header-section-number">12.5</span> Quality Control</a>
  <ul class="collapse">
  <li><a href="#general-metrics" id="toc-general-metrics" class="nav-link" data-scroll-target="#general-metrics"><span class="header-section-number">12.5.1</span> General metrics</a></li>
  <li><a href="#sequencing-depth-and-coverage" id="toc-sequencing-depth-and-coverage" class="nav-link" data-scroll-target="#sequencing-depth-and-coverage"><span class="header-section-number">12.5.2</span> Sequencing depth and coverage</a></li>
  <li><a href="#amplicon-dropout" id="toc-amplicon-dropout" class="nav-link" data-scroll-target="#amplicon-dropout"><span class="header-section-number">12.5.3</span> Amplicon dropout</a></li>
  </ul></li>
  <li><a href="#exercises" id="toc-exercises" class="nav-link" data-scroll-target="#exercises"><span class="header-section-number">12.6</span> Exercises</a></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary"><span class="header-section-number">12.7</span> Summary</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Lineage Abundance</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Learning Objectives
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Summarise the bioinformatic steps involved in estimating lineage abundance from sequencing data.</li>
<li>Apply the <code>nf-core/viralrecon</code> pipeline for wastewater analysis.</li>
<li>Evaluate sample quality with a particular focus on abundance estimation.</li>
<li>Interpret the results from the Freyja software and its limitations.</li>
<li>Prepare the abundance estimates for downstream analysis.</li>
</ul>
</div>
</div>
<section id="bioinformatic-analysis" class="level2" data-number="12.1">
<h2 data-number="12.1" class="anchored" data-anchor-id="bioinformatic-analysis"><span class="header-section-number">12.1</span> Bioinformatic analysis</h2>
<p>The bioinformatic analysis of wastewater sequencing data broadly involves the following steps:</p>
<ul>
<li>Filter the raw sequencing data to remove low-quality reads and trim Illumina adaptors.</li>
<li>Map the reads to the <em>Wuhan-Hu-1</em> reference genome.</li>
<li>Trim the primers from the aligned reads based on the primer location BED file.</li>
<li>Identify changes relative to the reference sequence.</li>
<li>Estimate the abundance of known SARS-CoV-2 lineages.</li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/workflow_ww_overview.svg" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Overview of the lineage abundance pipeline. The diagram illustrates Illumina sequencing, where each PCR amplicon is covered by 2 reads (read 1 and read 2). The PCR amplicons typically overlap, therefore the reads may also overlap in their alignment positions.</figcaption>
</figure>
</div>
<p>Most of these steps are in common with the <a href="../../materials/02-isolates/01-consensus.html">processing of clinical samples</a>. The main difference is the last step, where we use a specialised software to estimate the abundance of viral lineages based on the mutations found. There are different software packages designed to estimate lineage abundance from sequencing data and new ones are likely to be developed as the field evolves. See <a href="http://dx.doi.org/10.7717/peerj.14596">Kayikcioglu et al.&nbsp;2023</a> and <a href="https://doi.org/10.1101/2023.12.20.572426">Sutcliffe et al.&nbsp;2023</a> for an overview of the software packages available and their performance on synthetic data.</p>
<p>The software that we will use, implemented in the <code>nf-core/viralrecon</code> pipeline is called <strong>Freyja</strong>. This tool takes advantage of the large number of known lineages of SARS-CoV-2, which it pulls from the <a href="https://academic.oup.com/mbe/article/38/12/5819/6361626">UShER global phylogeny</a>. This global phylogeny is updated daily, and so is the Freyja database. Freyja combines the known mutations for each lineage with the frequency of observed mutations estimated from our sequencing data to estimate the frequency of those lineages.</p>
</section>
<section id="sec-ww-viralrecon" class="level2" data-number="12.2">
<h2 data-number="12.2" class="anchored" data-anchor-id="sec-ww-viralrecon"><span class="header-section-number">12.2</span> Wastewater pipeline</h2>
<p>We will use the same workflow covered in the <a href="../../materials/02-isolates/01-consensus.html">consensus assembly of clinical isolates</a>: <code>nf-core/viralrecon</code>. The current version of this pipeline includes the Freyja tool for inference of lineage abundance.</p>
<p>The command to process our samples is very similar to what we’ve seen before:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">nextflow</span> run nf-core/viralrecon <span class="dt">\</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">-r</span> dev <span class="at">-profile</span> singularity <span class="dt">\</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">--platform</span> illumina <span class="dt">\</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">--input</span> YOUR_SAMPLESHEET_CSV <span class="dt">\</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">--outdir</span> OUTPUT_DIRECTORY <span class="dt">\</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">--protocol</span> amplicon <span class="dt">\</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">--genome</span> <span class="st">'MN908947.3'</span> <span class="dt">\</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">--fasta</span> PATH_TO_FASTA_FILE <span class="dt">\</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">--gff</span> PATH_TO_GFF_FILE <span class="dt">\</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">--primer_bed</span> PATH_TO_BED_FILE <span class="dt">\</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">--skip_assembly</span> <span class="at">--skip_asciigenome</span> <span class="dt">\</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">--skip_consensus</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The key difference is:</p>
<ul>
<li><code>-r dev</code>: we are using the <strong>development version</strong> of the pipeline, which is not yet released as an official version. This is because Freyja is currently (Feb 2024) only available in the development version. Once a new version of the pipeline is released (&gt;= 2.7), it should no longer be necessary to use the development version.</li>
<li><code>--skip_consensus</code>: in this case we skip the generation of a consensus FASTA file. Since wastewater samples are mixed, it doesn’t make sense to generate a consensus FASTA file, as it would potentially include mutations from different lineages in the final consensus, creating artificial recombinant genomes.</li>
</ul>
<p>In addition, there are <a href="https://nf-co.re/viralrecon/dev/parameters#skip_freyja">other options</a> that can be specified with <code>viralrecon</code> to modify Freyja’s default behaviour. We highlight two important ones below: <code>--freyja_depthcutoff</code> and <code>--freyja_repeats</code>.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Samplesheet
</div>
</div>
<div class="callout-body-container callout-body">
<p>To automatically create a samplesheet CSV file from the FASTQ files in a directory, we can use <a href="https://github.com/nf-core/rnaseq/blob/master/bin/fastq_dir_to_samplesheet.py">this script</a> developed by the nf-core team. We have downloaded the script to a directory called <code>utilities</code> and produced the samplesheet using the following command:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> utilities/fastq_dir_to_samplesheet.py <span class="at">-r1</span> <span class="st">'_1.fastq.gz'</span> <span class="at">-r2</span> <span class="st">'_2.fastq.gz'</span> data/reads/ samplesheet.csv</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><code>-r1</code> defines the suffix of read 1 files</li>
<li><code>-r2</code> defines the suffix of read 2 files</li>
<li>Then we include the input directory with FASTQ files</li>
<li>At the end the name of the output samplesheet file</li>
</ul>
<p>This will generate a CSV file where the <code>sample</code> names are taken from the FASTQ filenames. If you want to use your own custom names, you can open this file in Excel and edit it the sample names to suit your needs.</p>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-3-contents" aria-controls="callout-3" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Pipeline details
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-3" class="callout-3-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>The processing of raw sequencing reads goes through several steps already covered in <a href="../02-isolates/01-consensus.html#sec-viralrecon"><span>Section&nbsp;4.3</span></a>. The main new step is the <strong>lineage abundance</strong> estimation done by Freyja. This software consists of 4 main commands:</p>
<ul>
<li><code>freyja variants</code> identifies mutations from the sequencing reads to obtain their frequencies and sequencing depth.</li>
<li><code>freyja update</code> is used to update the lineage database, pulled from the UShER global phylogeny.</li>
<li><code>freyja demix</code> does the actual estimation of lineage abundances.</li>
<li><code>freyja boot</code> calculates confidence intervals for the abundance estimates using a bootstrap method (see section below).</li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/viralrecon_workflow_ww_illumina.svg" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Diagram of the Illumina workflow for wastewater samples. Some steps have been omitted for simplification.</figcaption>
</figure>
</div>
</div>
</div>
</div>
<section id="depth-threshold" class="level3" data-number="12.2.1">
<h3 data-number="12.2.1" class="anchored" data-anchor-id="depth-threshold"><span class="header-section-number">12.2.1</span> Depth threshold</h3>
<p>The option <code>--freyja_depthcutoff</code> determines the minimum depth of sequencing for a site to be used in the Freyja analysis. The default is ‘0’, meaning Freyja uses all the sites in its analysis, as long as at least 1 read is mapped to the reference. This may seem too low, however recall that Freyja will use all the mutations across the genome, so as long as the average depth of sequencing is high enough (e.g.&nbsp;&gt;100x) and the genome is well covered (e.g.&nbsp;&gt;80%), then even if some of the sites have low depth, the accuracy of the final estimates might still be good.</p>
<p>Also, Freyja takes the depth of each site into account when it does it’s calculation, giving more weight to sites with more reads than those with very few reads.</p>
<p>The default threshold (<code>--freyja_depthcutoff 0</code>) usually leads to more lineages being reported in the output, although some of the low-frequency ones may be innacurate. We may increasing this threshold to be more strict (e.g.&nbsp;<code>--freyja_depthcutoff 5</code>), however this will lower our resolution and some minor lineages may not be captured.</p>
<p>As a first step we recommend keeping the default threshold and only increase it if you notice many false positive lineages systematically being reported.</p>
</section>
<section id="confidence-intervals" class="level3" data-number="12.2.2">
<h3 data-number="12.2.2" class="anchored" data-anchor-id="confidence-intervals"><span class="header-section-number">12.2.2</span> Confidence intervals</h3>
<p>The option <code>--freyja_repeats</code> is used to configure the calculation of confidence intervals for the abundance estimations. Freyja can quantify the uncertainty of its lineage abundance estimates, related to the sequencing depth. Our sequencing reads can be thought of as a sample from all the viral molecules present in our sequencing library. Therefore, a site with 10x reads will provide lower accuracy than a site with 100x reads.</p>
<p>The way Freyja quantify the uncertainty in lineage abundance due to sequencing depth is to use a method known as <strong>bootstrap resampling</strong>. This method works by taking a sample of reads with replacement and re-calculating the lineage abundance. This process is repeated several times (e.g.&nbsp;100 times) to generate a distribution of abundances, representing our uncertainty in the estimates due to the random sampling of reads in each position. Freyja then uses this distribution to calculate a 95% confidence for each lineage abundance. Watch <a href="https://youtu.be/Xz0x-8-cgaQ?feature=shared">this video</a> if you want to learn more about bootstrap resampling in general.</p>
<p>The <code>viralrecon</code> option <code>--freyja_repeats</code> determines the number of bootstrap repeats used to estimate confidence intervals for the abundance estimates. The default is 100 bootstrap replicates, which should be enough to get robust confidence intervals.</p>
<p>However, this step is <strong>very computationally demanding</strong>, substantially increasing the time to run the analysis (it is, essentially, running the Freyja step 100 times for each sample). Therefore, it can sometimes be advantageous to “turn off” this option by setting <code>--freyja_repeats 1</code>. In that case, make sure to <em>ignore the confidence intervals that are output by the pipeline</em>.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Freyja confidence intervals
</div>
</div>
<div class="callout-body-container callout-body">
<p>Note that the bootstrap confidence intervals generated by Freyja only account for the uncertainty related to sequencing depth. They do not take into account variation due to sampling at the wastewater treatment plant, and variation due to sample manipulation in the lab protocols.</p>
</div>
</div>
</section>
</section>
<section id="output-files" class="level2" data-number="12.3">
<h2 data-number="12.3" class="anchored" data-anchor-id="output-files"><span class="header-section-number">12.3</span> Output Files</h2>
<p>After running the pipeline, we get several output files (see <code>viralrecon</code>’s <a href="https://nf-co.re/viralrecon/">documentation</a>). These are very similar to what has been described for <a href="../../materials/02-isolates/02-qc.html">clinical isolates</a>. As a reminder, here are some files of interest:</p>
<ul>
<li><code>multiqc/multiqc_report.html</code>: a MultiQC quality report, including information about average depth of coverage, fraction of the genome covered, number of mutations identified, etc.</li>
<li><code>variants/bowtie2/</code>: directory with individual BAM files, which can be visualised with <em>IGV</em> if we want to look at the reads mapped to the reference genome.</li>
<li><code>variants/ivar/variants_long_table.csv</code>: a CSV file with the aggregated results of all the mutations detected in each sample.</li>
</ul>
<p>The new directories of particular interest for wastewater analysis are:</p>
<ul>
<li><code>variants/freyja/demix</code>: directory containing the output files from the <code>freyja demix</code> command, used to estimate lineage abundances.</li>
<li><code>variants/freyja/bootstrap</code>: directory containing the output files from the <code>freyja boot</code> command, used to get confidence intervals for the estimated lineage abundances.</li>
<li><code>variants/freyja/variants</code>: directory containing the output files from the <code>freyja variants</code> command, which includes all the variants (mutations) considered by Freyja in its lineage abundance calculations. These are somewhat redundant with the files in <code>variants/ivar/variants_long_table.csv</code>.</li>
</ul>
</section>
<section id="sec-demix" class="level2" data-number="12.4">
<h2 data-number="12.4" class="anchored" data-anchor-id="sec-demix"><span class="header-section-number">12.4</span> Freyja <code>demix</code> output</h2>
<p>The main step of the Freyja analysis is the command <code>freyja demix</code> (which <code>viralrecon</code> runs for us), where the mutations present in the sequencing reads are used to infer the abundance of individual lineages.</p>
<p>These files are text-based, but in a non-standard format. Here is an example from one of our samples:</p>
<pre><code>            SRR18541029.variants.tsv
summarized  [('Omicron', 0.9074885644836951), ('Delta', 0.04843510729864781), ('Other', 0.03151409250566481)]
lineages    BA.1 BA.1.1.8 BA.1.20 AY.116 BA.1.8 B.1.1.529 XS BA.1.1.17 XP XD BA.1.1.5 BA.1.1.10 AY.39 AY.46.1 AY.3.1
abundances  0.42763980 0.33859152 0.04909740 0.04170587 0.03905280 0.02662011 0.02634620 0.00904814 0.00811069 0.00516789 0.00476190 0.00456621 0.00277376 0.00206299 0.00189249
resid       13.531715333760909
coverage    98.86633448149016</code></pre>
<p>Here is the meaning of each line from this file:</p>
<ol type="1">
<li>The name of the file</li>
<li>The frequency of variants of concern, which is added up based on the frequency of individual lineages.</li>
<li>The name of each individual lineage detected in the sample.</li>
<li>The corresponding frequencies of each lineage from the previous line, in descending order.</li>
<li>The “residual” variation left from the statistical model used to estimate the frequencies; this value does not have an easy interpretation.</li>
<li>The percentage of the genome covered at 10x depth. We can also obtain this information from the regular MultiQC report (see more about this in the QC section below).</li>
</ol>
<p>We will later use a custom script to “tidy” these results into a more standard CSV format, aggregating the results from several samples and combining it with our metadata.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Ambiguous lineage abundance
</div>
</div>
<div class="callout-body-container callout-body">
<p>For similar lineages (i.e.&nbsp;with few distinguishing mutations) it can sometimes happen that Freyja cannot distinguish their abundance. This usually affects lower-frequency lineages, as there are fewer reads to cover them to start with.</p>
<p>In those situations, Freyja will assign equal frequency to all of them. This is important to know, as it means that the frequency of those lineages is likely to be inaccurate.</p>
<p>Generally, low-abundance lineages (&lt; 1%) should be interpreted with caution, in particular for samples with low median depth of sequencing.</p>
</div>
</div>
</section>
<section id="quality-control" class="level2" data-number="12.5">
<h2 data-number="12.5" class="anchored" data-anchor-id="quality-control"><span class="header-section-number">12.5</span> Quality Control</h2>
<p>As usual, the first thing to do after running our pipeline is to check the quality of our results. For wastewater samples, there are a few main diagnostics to pay attention to:</p>
<ul>
<li>The average depth of sequencing of our samples, i.e.&nbsp;the average number of reads mapped to each position of the genome.</li>
<li>Whether there was any amplicon dropout.</li>
<li>The percentage of the genome covered at a certain depth of sequencing.</li>
</ul>
<p>In addition, general quality metrics should also be considered, which we also cover below.</p>
<p>These metrics are all available from the MultiQC report generated by the pipeline saved in <code>multiqc/multiqc_report.html</code>.</p>
<section id="general-metrics" class="level3" data-number="12.5.1">
<h3 data-number="12.5.1" class="anchored" data-anchor-id="general-metrics"><span class="header-section-number">12.5.1</span> General metrics</h3>
<p>One of the first sections of the MultiQC report is “<strong>Variant calling metrics</strong>”, which contains a table with several metrics of interest, for example:</p>
<pre><code>Sample      # Input reads  % Non-host reads  # Trimmed reads (fastp)   % Mapped reads  # Mapped reads  # Trimmed reads (ivar)  Coverage median  % Coverage &gt; 1x   % Coverage &gt; 10x
Sample1     751204         NA                697880                    697880          100.00           697867                 1246.00           100.00           100.00
Sample2     377092         NA                331424                    331424          100.00           331404                 377.00            99.00            95.00
Sample3     174642         NA                134338                    134338          100.00           134282                 65.00             99.00            90.00
Sample4     14378          NA                12808                     12808           100.00           12800                  24.00             97.00            77.00</code></pre>
<p>These columns give us:</p>
<ul>
<li>The total number of reads that we started with.</li>
<li>The percentage of those reads that matched the human genome.</li>
<li>The number of reads that passed the quality filtering step, which includes adapter removal and quality trimming (using the <code>fastp</code> software).</li>
<li>The number and percentage of mapped reads. This is a good indicator of whether the sample contains non-human contamination, as that would result in lower mapping rates to the SARS-CoV-2 reference genome.</li>
<li>The number of reads that had the amplicon primer site trimmed (using <code>ivar</code> software). It is expected that most reads will start at the primer site, so this number should be similar to the number of mapped reads. However, depending on the type of library used, this number might be smaller.</li>
</ul>
<p>These initial metrics are essential to analyse, as it informs us of whether our samples are free of contamination and generally aligned well to the SARS-CoV-2 reference genome.</p>
<p>We should also assess the quality of our raw reads, by looking at the section “<strong>FastQC (raw reads)</strong>”, as detailed in <a href="../01-intro/02-ngs.html#sec-fastqc"><span>Section&nbsp;2.2.2</span></a>.</p>
</section>
<section id="sequencing-depth-and-coverage" class="level3" data-number="12.5.2">
<h3 data-number="12.5.2" class="anchored" data-anchor-id="sequencing-depth-and-coverage"><span class="header-section-number">12.5.2</span> Sequencing depth and coverage</h3>
<p>The “Variant calling metrics” table has a few other metrics of particular interest for wastewater samples, namely:</p>
<ul>
<li><strong>Coverage median:</strong> the number of reads that maps to each position of the genome <em>on average</em>.</li>
<li><strong>% Coverage &gt; 10x:</strong> the fraction of the genome that is covered with at least 10 reads.</li>
</ul>
<p>These two metrics together give us an idea of how much of the genome we have effectively sequenced and how deeply we have sequenced it. As mentioned earlier, the sequencing depth is critical for the estimation of lineage abundance. The more we sequence a sample, the more accurate are <em>Freyja</em>’s abundance estimates, as well as our ability to detect low-abundance lineages.</p>
<p>The two metrics on this table are useful summaries, however we can get an even more detailed insights from looking at the plot show in the section “<strong>Mosdepth</strong> &gt; <strong>Cumulative coverage distribution</strong>” (see figure below).</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/mosdepth.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Snapshot of the coverage distribution plot from the <code>mosdepth</code> software. This plot allows us to evaluate what fraction of the genome is covered at a certain depth of sequencing. There are two ways to interpret this plot: “what fraction of the genome is covered at a certain minimum depth?” (vertical line, left); or “what is the maximum depth covering at least X% of the genome?” (horizontal line, right).</figcaption>
</figure>
</div>
<p>There is no defined rule for which depth and/or coverage thresholds to use to keep or remove a sample from downstream analysis. Take “Sample4” in our example above: it only has a median depth of 24x with 77% of the genome covered at 10x, and a very sharp curve in the cumulative coverage plot. Should we remove this sample from further analysis? On the one hand, this sample may give less accurate information compared to other samples. On the other hand, if a high-frequency variant is present, we may still be able to detect it and it may therefore be a useful data point for our analysis.</p>
</section>
<section id="amplicon-dropout" class="level3" data-number="12.5.3">
<h3 data-number="12.5.3" class="anchored" data-anchor-id="amplicon-dropout"><span class="header-section-number">12.5.3</span> Amplicon dropout</h3>
<p>Another consideration to take is whether there was any PCR amplicon dropout (detailed in <a href="../02-isolates/02-qc.html#sec-amplicon-coverage"><span>Section&nbsp;5.2.2</span></a>). In particular, if you sistematically failed to amplify the <em>S</em> (<em>Spike</em>) gene, where many lineage-distinguishing mutations occur, this may lead to poorer lineage abundance estimation, as we are missing data in those regions of the genome.</p>
<p>Again, there is no rule about whether or not to exclude a sample from analysis based on amplicon dropout, but it is important to look at the <strong>Amplicon Coverage Heatmap</strong> of the <em>MultiQC</em> report and make a note of any samples that may be particularly problematic.</p>
<p>A sistematic amplicon dropout may indicate that improvements are needed during the lab protocols or that new primer panels are required.</p>
<p>In some cases, amplicon dropout is lineage-specific, for example due to mutations in the primer sites. These cases will be very difficult to detect in wastewater samples, since they usually contain mixed lineages. If a lineage is characterised by several mutations across different amplicons, this may not cause an issue, as <em>Freyja</em> will still be able to calculate its frequency from the other mutations. However, in some situations it may lead to a bias that we cannot easily control for.</p>
<p>The figure below illustrates this issue, as well as the issue of low depth of sequencing discussed earlier.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/ww_depth_and_coverage.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Diagram illustrating the consequence of having low depth of sequencing, complete amplicon dropout or lineage-specific amplicon dropout. Yellow stars illustrate mutations and red boxes regions of the genome with no coverage.</figcaption>
</figure>
</div>
<p>In summary, although it is not always easy to decide whether to keep or remove a sample from analysis, evaluating the sequencing depth and genome coverage is a good indicator for which samples may be more or less accurate. We may decide to keep them in our analysis, knowing that we need to interpret their results more carefully. Finally, for surveillance purposes, you may want to discuss as a team which thresholds you want to use to exclude samples from reporting and consistently apply those across the teams performing the data analysis.</p>
<!-- ## Limitations

- If a lineage is unknown then not much can be done about it...
- Normalisation across sites is not trivial
- Lineages with few mutations different are a problem:
  - Can use outbreak.info/compare-lineages to compare lineages. This is based on amino acid differences (not nucleotide)
  - Can use the usher barcodes on Freyja website. Here's a code snippet:
    
```r
usher <- read_csv("https://github.com/andersen-lab/Freyja/raw/main/freyja/data/usher_barcodes.csv")
usher <- usher |> 
  column_to_rownames("...1") |> 
  as.matrix()

colnames(usher)[(colSums(usher[c("JN.1", "BA.2.86.1"), ]) == 1)]
``` 
-->
</section>
</section>
<section id="exercises" class="level2" data-number="12.6">
<h2 data-number="12.6" class="anchored" data-anchor-id="exercises"><span class="header-section-number">12.6</span> Exercises</h2>
<div class="callout callout-style-default callout-exercise no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-7-contents" aria-controls="callout-7" aria-expanded="true" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Run viralrecon for wastewater samples
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-7" class="callout-7-contents callout-collapse collapse show">
<div class="callout-body-container callout-body">
<div>
<div class="callout-exercise">
<p>TODO - add exercise preamble</p>
<ol type="1">
<li>Use the script <code>utilites/fastq_dir_to_samplesheet.py</code> to generate a samplesheet from the reads in <code>data/reads</code> directory. See the tip box in <a href="#sec-ww-viralrecon"><span>Section&nbsp;12.2</span></a>.</li>
<li>Open the <em>shell script</em> called <code>scripts/01-run_viralrecon.sh</code>, which contains part of the command to run your samples through the viralrecon pipeline. Fix the script where the word “FIXME” appears:</li>
</ol>
<ul>
<li>Use as input the samplesheet generated in the previous step.</li>
<li>Output the results to the directory <code>results/viralrecon</code>.</li>
</ul>
<p>You will notice the <code>viralrecon</code> command includes direct path to the reference genome, gene annotation and primer file. This is because these samples were processed with the SWIFT primers, which are proprietary. Furthermore, we use the option <code>--ivar_trim_offset 5</code>, which is recommended in the <a href="https://nf-co.re/viralrecon/2.6.0/docs/usage#swift-primer-sets">viralrecon documentation</a> for these primers.<br>
Note that the primer BED we are using here is not the official file from the company, they are approximate coordinates used only for training purposes.</p>
<div class="callout callout-style-default callout-answer no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-6-contents" aria-controls="callout-6" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Answer
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-6" class="callout-6-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div>
<div class="callout-answer">
<p>TODO - finish the answer</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="ex">nextflow</span> run nf-core/viralrecon <span class="dt">\</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">-r</span> dev <span class="at">-profile</span> singularity <span class="dt">\</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">--platform</span> illumina <span class="dt">\</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">--input</span> samplesheet.csv <span class="dt">\</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">--outdir</span> results/viralrecon <span class="dt">\</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">--protocol</span> amplicon <span class="dt">\</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">--fasta</span> <span class="st">'resources/reference/sarscov2_genome.fasta'</span> <span class="dt">\</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">--gff</span> <span class="st">'resources/reference/sarscov2_annotation.gff'</span> <span class="dt">\</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">--primer_bed</span> <span class="st">'resources/primers/swift_v2.bed'</span> <span class="dt">\</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">--ivar_trim_offset</span> 5 <span class="dt">\</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">--freyja_repeats</span> 100 <span class="dt">\</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">--skip_assembly</span> <span class="at">--skip_asciigenome</span> <span class="dt">\</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">--skip_consensus</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="callout callout-style-default callout-exercise no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-9-contents" aria-controls="callout-9" aria-expanded="true" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Cleaning Freyja Output
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-9" class="callout-9-contents callout-collapse collapse show">
<div class="callout-body-container callout-body">
<div>
<div class="callout-exercise">
<p>To make our downstream analysis easier, we provide a script that can be used to compile all the Freyja outputs into “tidy” CSV files.</p>
<p>The script works by taking as input the directory with the <code>viralrecon</code> results, and it automatically reads all the <em>Freyja</em> files to generate two CSV files: <code>lineage_abundances.csv</code> and <code>vocs_abundances.csv</code>. These files contain, respectively, the abundances of individual lineages and the abundances aggregated by variants of concern (equivalent to the output from <code>freyja demix</code> detailed in <a href="#sec-demix"><span>Section&nbsp;12.4</span></a>). Additionally, it contains the confidence intervals for each estimate calculated by <code>freyja boot</code>. Finally, you can optionally provide a metadata CSV file, which will be joined with the abundances for easier downstream analysis and interpretation.</p>
<p>Here is an example of the <code>vocs_abundance.csv</code> file from the script:</p>
<pre><code>sample       name     abundance              boot_lo               boot_up               date        country        city       latitude   longitude
SRR18541074  Delta    0.9640087907444956     0.9596984293917038    0.9682214940819226    2021-12-01  United States  San Diego  32.719875  -117.170082
SRR18541074  Omicron  0.019682409750709555   0.013233836060878133  0.02276906228234253   2021-12-01  United States  San Diego  32.719875  -117.170082
SRR18541074  Other    0.0012202492036713667  0.0                   0.008722550206162935  2021-12-01  United States  San Diego  32.719875  -117.170082
SRR18541043  Omicron  0.8762933605967606     0.8732252984148029    0.8812933627570921    2021-12-26  United States  San Diego  32.719875  -117.170082</code></pre>
<p>The first 5 columns come from <em>Freyja</em>:</p>
<ul>
<li><code>sample</code> is the sample name</li>
<li><code>name</code> is the lineage or variant name</li>
<li><code>abundance</code> is the abundance estimate</li>
<li><code>boot_lo</code> is the lower bound of the bootstrap 95% confidence interval</li>
<li><code>boot_up</code> is the upper bound of the confidence interval</li>
</ul>
<p>The remaining columns are part of our metadata, which in this case includes date of collection and location information.</p>
<p>Your task for this exercise is to run the script on the preprocessed results in <code>preprocessed/viralrecon</code>. To see how you should run the script, look at its help:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> utilities/tidy_freyja_viralrecon.py <span class="at">--help</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Use 70% as the minimum coverage to keep a sample in the output, and save the files in a directory called <code>results/tidyfreyja</code>.</p>
<p>Once you run the script, open the resulting files in <em>Excel</em> and answer the following questions:</p>
<ul>
<li>Are there any lineages that are present at &gt;75% frequency in any of the samples?</li>
<li>How about variants of concern?</li>
<li>If you sort the table by date, can you see a pattern in which variants of concern are present across time?</li>
</ul>
<div class="callout callout-style-default callout-answer no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-8-contents" aria-controls="callout-8" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Answer
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-8" class="callout-8-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div>
<div class="callout-answer">
<p>We can use the following command to run the script (use use <code>\</code> to split the command across multiple lines for readability):</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> utilities/tidy_freyja_viralrecon.py <span class="dt">\</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">--viralrecon_results</span> preprocessed/viralrecon/ <span class="dt">\</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">--outdir</span> results/tidyfreyja <span class="dt">\</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">--metadata</span> sample_info.csv <span class="dt">\</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">--mincov</span> 70</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This generates two files in the folder <code>results/tidyfreyja</code>.</p>
<p>We open both files in <em>Excel</em> to answer the questions:</p>
<ul>
<li>Are there any lineages that are present at &gt;75% frequency in any of the samples?
<ul>
<li>Only three samples have lineages with &gt;75% frequency. Those lineages are AY.103, AY.100 and AY.116.</li>
</ul></li>
<li>How about variants of concern?
<ul>
<li>There are several samples with variants of concern (VOCs) at &gt;75% frequency. There are two VOCs: delta and omicron.</li>
</ul></li>
<li>If you sort the table by date, can you see a pattern in which variants of concern are present across time?
<ul>
<li>There is a noticeable pattern of the Delta variant being replaced by Omicron around Dec 2021.</li>
</ul></li>
</ul>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="summary" class="level2" data-number="12.7">
<h2 data-number="12.7" class="anchored" data-anchor-id="summary"><span class="header-section-number">12.7</span> Summary</h2>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Key Points
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>The main bioinformatic steps for lineage abundance estimation from sequencing data are: quality filtering of raw reads, mapping to the reference genome, trimming PCR primers, identifying mutations and their frequency and estimating lineage abundance.</li>
<li>The development version of <code>viralrecon</code> can perform lineage abundance using the <em>Freyja</em> software.
<ul>
<li>For wastewater data, we usually skip the generation of a consensus genome, as it would not necessarily be reflective of the genomes present in the sample.</li>
</ul></li>
<li><em>Freyja</em> combines mutation frequencies and their sequencing depth with known lineage mutations, to infer their frequencies in the sample.
<ul>
<li>Higher sequencing depth gives more accurate estimates.</li>
<li>Low-frequency lineages are harder to detect and their frequency estimates less accurate.</li>
<li>Very similar lineages may be artificially assigned the same frequency, if some of their distinctive mutations are missing from our data.</li>
</ul></li>
<li>Sequencing depth, genome coverage and amplicon dropout are important metrics to assess the quality of wastewater samples, as they may affect the accuracy of lineage abundance estimation.</li>
<li>Lineage abundance estimation relies on previously known lineages, and therefore new lineages are not directly reported.</li>
</ul>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../../materials/04-wastewater/01-ww_surveillance.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Wastewater Surveillance</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../../materials/04-wastewater/03-ww_visualisation.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Abundance Visualisation</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">Licensed <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> <img src="https://creativecommons.org/images/deed/cc_icon_black_x2.png" class="img-fluid" width="25"> Bioinformatics Training Facility</div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>



</body></html>